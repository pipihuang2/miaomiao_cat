name: Notify Feishu on PR

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]  # å¤„ç†PRåˆ›å»ºã€æ›´æ–°ã€é‡æ–°æ‰“å¼€å’Œå…³é—­äº‹ä»¶
  pull_request_review:
    types: [submitted, edited]  # ç”¨äºPRå®¡æŸ¥è€…çš„æ•´ä½“è¯„è®º
  pull_request_review_comment:
    types: [created, edited]  # ç”¨äºä»£ç è¡Œçš„è¯„è®º
  issue_comment:
    types: [created, edited]  # ç”¨äºPRçš„ç›´æ¥è¯„è®º

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Check event payload (for debugging)
        run: |
          echo "Event Name: ${{ github.event_name }}"
          echo "Action: ${{ github.event.action }}"
          echo "PR Title: ${{ github.event.issue.title }}"
          echo "Comment Body: ${{ github.event.comment.body }}"
          echo "PR Branch: ${{ github.event.pull_request.head.ref }}"
          echo "PR State: ${{ github.event.pull_request.state }}"  # è·å–PRçŠ¶æ€ï¼Œclosedæˆ–open

      - name: Send PR Notification to Feishu
        run: |
          # è·å–äº‹ä»¶ç±»å‹å’Œç›¸å…³ä¿¡æ¯
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            pr_title="${{ github.event.pull_request.title }}"
            pr_url="${{ github.event.pull_request.html_url }}"
            pr_creator="${{ github.event.pull_request.user.login }}"
            pr_branch="${{ github.event.pull_request.head.ref }}"  # è·å–æºåˆ†æ”¯
            if [[ "${{ github.event.action }}" == "opened" ]]; then
              # PR åˆ›å»ºäº‹ä»¶
              msg="ğŸ“¢ æ–°çš„ Pull Request åˆ›å»ºï¼\næ ‡é¢˜: $pr_title\nåˆ›å»ºäºº: $pr_creator\nåˆ†æ”¯: $pr_branch\nğŸ”— $pr_url"
            elif [[ "${{ github.event.action }}" == "synchronize" ]]; then
              # PR æ›´æ–°äº‹ä»¶ï¼ˆä»£ç æ¨é€ï¼‰
              pr_updater="${{ github.event.pull_request.user.login }}"
              msg="ğŸ”„ Pull Request æ›´æ–°ï¼\næ ‡é¢˜: $pr_title\næ›´æ–°äºº: $pr_updater\nåˆ†æ”¯: $pr_branch\nğŸ”— $pr_url"
            elif [[ "${{ github.event.action }}" == "closed" ]]; then
              # PR å…³é—­äº‹ä»¶
              pr_closer="${{ github.event.pull_request.user.login }}"
              msg="âŒ Pull Request å·²å…³é—­ï¼\næ ‡é¢˜: $pr_title\nå…³é—­äºº: $pr_closer\nåˆ†æ”¯: $pr_branch\nğŸ”— $pr_url"
            fi
          elif [[ "${{ github.event_name }}" == "pull_request_review" ]]; then
            pr_title="${{ github.event.pull_request.title }}"
            pr_url="${{ github.event.pull_request.html_url }}"
            reviewer="${{ github.event.review.user.login }}"
            review_state="${{ github.event.review.state }}"  # è·å–å®¡æŸ¥çŠ¶æ€
            pr_branch="${{ github.event.pull_request.head.ref }}"  # è·å–æºåˆ†æ”¯
            if [[ "$review_state" == "commented" ]]; then
              # å¦‚æœå®¡æŸ¥çŠ¶æ€ä¸º "commented"ï¼Œè·å–è¯„è®ºå†…å®¹
              msg="ğŸ” PR å®¡æŸ¥è¯„è®ºå·²æäº¤ï¼\næ ‡é¢˜: $pr_title\nè¯„è®ºäºº: $reviewer\nå®¡æŸ¥çŠ¶æ€: commented\nåˆ†æ”¯: $pr_branch\nğŸ”— $pr_url\nğŸ’¬ è¯„è®ºå†…å®¹: ${{ github.event.review.body }}"
            else
              msg="ğŸ” PR å®¡æŸ¥è¯„è®ºå·²æäº¤ï¼\næ ‡é¢˜: $pr_title\nè¯„è®ºäºº: $reviewer\nå®¡æŸ¥çŠ¶æ€: $review_state\nåˆ†æ”¯: $pr_branch\nğŸ”— $pr_url"
            fi
          elif [[ "${{ github.event_name }}" == "pull_request_review_comment" ]]; then
            pr_title="${{ github.event.pull_request.title }}"
            pr_url="${{ github.event.pull_request.html_url }}"
            commenter="${{ github.event.comment.user.login }}"
            comment_body="${{ github.event.comment.body }}"
            pr_branch="${{ github.event.pull_request.head.ref }}"  # è·å–æºåˆ†æ”¯
            msg="ğŸ’¬ PR ä»£ç è¡Œè¯„è®ºå·²æ›´æ–°ï¼\næ ‡é¢˜: $pr_title\nè¯„è®ºäºº: $commenter\nåˆ†æ”¯: $pr_branch\nğŸ”— $pr_url\nğŸ’¬ è¯„è®ºå†…å®¹: $comment_body"
          elif [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            # å¤„ç†PRçš„ç›´æ¥è¯„è®º
            pr_title="${{ github.event.issue.title }}"
            pr_url="${{ github.event.issue.html_url }}"
            commenter="${{ github.event.comment.user.login }}"
            comment_body="${{ github.event.comment.body }}"
            pr_branch="${{ github.event.pull_request.head.ref }}"  # è·å–æºåˆ†æ”¯
            msg="ğŸ’¬ PR ç›´æ¥è¯„è®ºå·²æ›´æ–°ï¼\næ ‡é¢˜: $pr_title\nè¯„è®ºäºº: $commenter\nåˆ†æ”¯: $pr_branch\nğŸ”— $pr_url\nğŸ’¬ è¯„è®ºå†…å®¹: $comment_body"
          fi
          # å‘é€æ¶ˆæ¯åˆ°é£ä¹¦
          curl -X POST "https://open.feishu.cn/open-apis/bot/v2/hook/d15977a4-387f-4c2b-8335-af382c393867" \
          -H "Content-Type: application/json" \
          -d "{
            \"msg_type\": \"text\",
            \"content\": {
              \"text\": \"$msg\"
            }
          }"
